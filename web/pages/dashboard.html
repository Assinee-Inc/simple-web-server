{{ define "title" }} Início {{ end }}
{{ define "content" }}
<!-- Container fluid -->
<div class="container-fluid p-6">
  <div class="row">
    <div class="col-lg-12 col-md-12 col-12">
      <!-- Page header -->
      <div class="border-bottom pb-4 mb-4">
        <div class="row align-items-center">
          <div class="col">
            <h3 class="mb-0 fw-bold">Dashboard</h3>
            <p class="mb-0 text-muted">Visão geral das estatísticas e métricas do sistema</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- content -->
  <div class="py-6">
    <!-- Statistics Cards Row -->
    <div class="row mb-6">
      <div class="col-xl-3 col-lg-6 col-md-12 col-12 mb-4">
        <!-- card -->
        <div class="card h-100">
          <!-- card body -->
          <div class="card-body">
            <!-- heading -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h4 class="mb-0">Ebooks</h4>
              </div>
              <div class="icon-shape icon-md bg-light-primary text-primary rounded-2">
                <i class="fa-solid fa-book fs-4"></i>
              </div>
            </div>
            <!-- project number -->
            <div>
              <h1 class="fw-bold">{{.TotalEbooks}}</h1>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-lg-6 col-md-12 col-12 mb-4">
        <!-- card -->
        <div class="card h-100">
          <!-- card body -->
          <div class="card-body">
            <!-- heading -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h4 class="mb-0">Clientes</h4>
              </div>
              <div class="icon-shape icon-md bg-light-primary text-primary rounded-2">
                <i class="fa-solid fa-users fs-4"></i>
              </div>
            </div>
            <!-- project number -->
            <div>
              <h1 class="fw-bold">{{.GetTotalClients}}</h1>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-lg-6 col-md-12 col-12 mb-4">
        <!-- card -->
        <div class="card h-100">
          <!-- card body -->
          <div class="card-body">
            <!-- heading -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h4 class="mb-0">Vendas</h4>
              </div>
              <div class="icon-shape icon-md bg-light-primary text-primary rounded-2">
                <i class="fa-solid fa-paper-plane fs-4"></i>
              </div>
            </div>
            <!-- project number -->
            <div>
              <h1 class="fw-bold">{{.GetTotalSendEbooks}}</h1>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-lg-6 col-md-12 col-12 mb-4">
        <!-- card -->
        <div class="card h-100">
          <!-- card body -->
          <div class="card-body">
            <!-- heading -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h4 class="mb-0">Baixados</h4>
              </div>
              <div class="icon-shape icon-md bg-light-primary text-primary rounded-2">
                <i class="fa-solid fa-download fs-4"></i>
              </div>
            </div>
            <!-- project number -->
            <div>
              <h1 class="fw-bold">0</h1>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section - Line Charts -->
    <div class="row mb-6">
      <!-- Daily Purchases Chart -->
      <div class="col-xl-6 col-lg-6 col-md-12 col-12 mb-4">
        <div class="card h-100">
          <div class="card-header bg-white py-4">
            <h4 class="mb-0">Vendas por dia (Últimos 7 dias)</h4>
          </div>
          <div class="card-body">
            <div id="purchasesChart" style="min-height: 300px;"></div>
          </div>
        </div>
      </div>

      <!-- Daily Downloads Chart -->
      <div class="col-xl-6 col-lg-6 col-md-12 col-12 mb-4">
        <div class="card h-100">
          <div class="card-header bg-white py-4">
            <h4 class="mb-0">Downloads por dia (Últimos 7 dias)</h4>
          </div>
          <div class="card-body">
            <div id="downloadsChart" style="min-height: 300px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section - Bar Charts and Table -->
    <div class="row mb-6">
      <!-- Top Ebooks Chart -->
      <div class="col-xl-4 col-lg-4 col-md-12 col-12 mb-4">
        <div class="card h-100">
          <div class="card-header bg-white py-4">
            <h4 class="mb-0">Top 3 Ebooks mais enviados</h4>
          </div>
          <div class="card-body">
            <div id="topEbooksChart" style="min-height: 300px;"></div>
          </div>
        </div>
      </div>

      <!-- Top Downloaded Ebooks -->
      <div class="col-xl-4 col-lg-4 col-md-12 col-12 mb-4">
        <div class="card h-100">
          <div class="card-header bg-white py-4">
            <h4 class="mb-0">Top 3 Ebooks mais baixados</h4>
          </div>
          <div class="card-body">
            <div id="topDownloadedEbooksChart" style="min-height: 300px;"></div>
          </div>
        </div>
      </div>

      <!-- Top Clients -->
      <div class="col-xl-4 col-lg-4 col-md-12 col-12 mb-4">
        <div class="card h-100">
          <div class="card-header bg-white py-4">
            <h4 class="mb-0">Top 10 Clientes</h4>
          </div>
          <div class="card-body">
            <div class="d-flex flex-column gap-3">
              {{ range .TopClients }}
              <div class="d-flex align-items-center p-3 border rounded-3 bg-light">
                <div class="me-3">
                  <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <span class="text-white fw-bold">{{ .Initials }}</span>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-1 fw-semibold">{{ .Name }}</h6>
                  <p class="mb-0 text-muted small">{{ .Email }}</p>
                </div>
                <div class="text-end">
                  <span class="badge bg-primary rounded-pill">{{ .TotalPurchases }} compras</span>
                </div>
              </div>
              {{ end }}
              {{ if not .TopClients }}
              <div class="text-center py-4">
                <div class="icon-shape icon-lg bg-light-primary text-primary rounded-3 mx-auto mb-3">
                  <i class="fa-solid fa-users fs-4"></i>
                </div>
                <h6 class="text-muted">Nenhum cliente encontrado</h6>
                <p class="text-muted small mb-0">Os clientes mais ativos aparecerão aqui</p>
              </div>
              {{ end }}
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="row">
    <div class="col-xl-12 col-lg-12 col-md-12 col-12">
      <!-- card  -->
      <div class="card h-100">
        <!-- card header  -->
        <div class="card-header bg-white py-4">
          <h4 class="mb-0">Estatísticas dos envios</h4>
        </div>
        {{ if .EbookStats }}
        <!-- ebook stats cards -->
        <div class="card-body">
          <div class="row">
            {{ range .EbookStats}}
            <div class="col-xl-12 col-lg-12 col-md-12 col-12 mb-4">
              <div class="card border-0 bg-light">
                <div class="card-body p-4">
                  <div class="row align-items-center">
                    <!-- Ebook Info -->
                    <div class="col-xl-4 col-lg-4 col-md-12 col-12 mb-3 mb-xl-0">
                      <div class="d-flex align-items-center">
                        <div class="icon-shape icon-md bg-primary text-white rounded-3 me-3">
                          <i class="fa-solid fa-book fs-4"></i>
                        </div>
                        <div>
                          <h5 class="mb-1 fw-semibold">{{.Title}}</h5>
                          <p class="mb-0 text-muted small">Ebook</p>
                        </div>
                      </div>
                    </div>

                    <!-- Metrics -->
                    <div class="col-xl-2 col-lg-2 col-md-4 col-6 mb-3 mb-xl-0">
                      <div class="text-center">
                        <div class="h4 mb-1 fw-bold text-primary">{{.TotalPurchases}}</div>
                        <div class="text-muted small">Vendas</div>
                      </div>
                    </div>

                    <div class="col-xl-2 col-lg-2 col-md-4 col-6 mb-3 mb-xl-0">
                      <div class="text-center">
                        <div class="h4 mb-1 fw-bold text-success">{{.TotalClients}}</div>
                        <div class="text-muted small">Clientes</div>
                      </div>
                    </div>

                    <div class="col-xl-2 col-lg-2 col-md-4 col-6 mb-3 mb-xl-0">
                      <div class="text-center">
                        <div class="h4 mb-1 fw-bold text-info">{{.PercentDownloads}}%</div>
                        <div class="text-muted small">Downloads</div>
                      </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="col-xl-2 col-lg-2 col-md-12 col-12">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">Taxa</span>
                        <span class="text-muted small">{{.PercentDownloads}}%</span>
                      </div>
                      <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: {{.PercentDownloads}}%" aria-valuenow="{{.PercentDownloads}}" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {{end}}
          </div>
        </div>
        {{ else }}
        <!-- empty state -->
        <div class="card-body text-center py-5">
          <div class="icon-shape icon-lg bg-light text-primary rounded-3 mx-auto mb-3">
            <i class="fa-solid fa-chart-line fs-4"></i>
          </div>
          <h6 class="text-muted">Nenhuma estatística disponível</h6>
          <p class="text-muted small mb-0">As estatísticas dos envios aparecerão aqui</p>
        </div>
        {{ end }}
        <!-- card footer  -->
        <div class="card-footer bg-white text-center">
          <a href="/purchase/sales" class="btn btn-outline-primary">
            <i class="fa-solid fa-paper-plane icon-xs me-2"></i>
            Ver todas as vendas
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ApexCharts -->
<link rel="stylesheet" href="/assets/libs/apexcharts/dist/apexcharts.css">
<script src="/assets/libs/apexcharts/dist/apexcharts.min.js"></script>

<script>
  // Check if ApexCharts is loaded
  if (typeof ApexCharts === 'undefined') {
    console.error('ApexCharts not loaded, falling back to Chart.js');
    // Fallback to Chart.js
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = function () {
      console.log('Chart.js loaded as fallback');
      initializeCharts();
    };
    document.head.appendChild(script);
  } else {
    console.log('ApexCharts loaded successfully');
    initializeCharts();
  }

  function initializeCharts () {
    // Get JSON data from Go template variables
    const dailyPurchasesData = JSON.parse('{{.DailyPurchasesJSON}}') || [];
    const dailyDownloadsData = JSON.parse('{{.DailyDownloadsJSON}}') || [];
    const topEbooksData = JSON.parse('{{.TopEbooksJSON}}') || [];
    const topDownloadedEbooksData = JSON.parse('{{.TopDownloadedEbooksJSON}}') || [];


    console.log('Data loaded:', {
      dailyPurchases: dailyPurchasesData,
      dailyDownloads: dailyDownloadsData,
      topEbooks: topEbooksData,
      topDownloadedEbooks: topDownloadedEbooksData,

    });

    // Generate last 7 days labels
    function getLast7Days () {
      const dates = [];
      const displayDates = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        // Keep original format for data mapping
        const originalFormat = date.toISOString().split('T')[0];
        dates.push(originalFormat);
        // Create display format
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        displayDates.push(`${day}/${month}/${year}`);
      }
      return { dates, displayDates };
    }

    const { dates: last7Days, displayDates: last7DaysDisplay } = getLast7Days();

    // Create data maps for purchases and downloads
    const purchasesMap = new Map(dailyPurchasesData.map(item => [item.date, item.count]));
    const downloadsMap = new Map(dailyDownloadsData.map(item => [item.date, item.count]));

    // Fill in data for all 7 days
    const dailyPurchasesCounts = last7Days.map(date => purchasesMap.get(date) || 0);
    const dailyDownloadsCounts = last7Days.map(date => downloadsMap.get(date) || 0);

    // Process data for other charts
    const topEbooksLabels = topEbooksData.map(item => item.title);
    const topEbooksCounts = topEbooksData.map(item => item.total_purchases);

    const topDownloadedEbooksLabels = topDownloadedEbooksData.map(item => item.title);
    const topDownloadedEbooksCounts = topDownloadedEbooksData.map(item => item.total_downloads);



    // Daily Purchases Chart
    const purchasesOptions = {
      series: [{
        name: 'Vendas',
        data: dailyPurchasesCounts
      }],
      chart: {
        type: 'area',
        height: 300,
        toolbar: {
          show: false
        },
        animations: {
          enabled: true,
          easing: 'easeinout',
          speed: 800,
          animateGradually: {
            enabled: true,
            delay: 150
          },
          dynamicAnimation: {
            enabled: true,
            speed: 350
          }
        }
      },
      colors: ['#5E72E4'],
      fill: {
        type: 'gradient',
        gradient: {
          shadeIntensity: 1,
          opacityFrom: 0.7,
          opacityTo: 0.2,
          stops: [0, 90, 100]
        }
      },
      dataLabels: {
        enabled: false
      },
      stroke: {
        curve: 'smooth',
        width: 3
      },
      xaxis: {
        categories: last7DaysDisplay,
        labels: {
          style: {
            colors: '#6B7280',
            fontSize: '12px'
          }
        }
      },
      yaxis: {
        labels: {
          style: {
            colors: '#6B7280',
            fontSize: '12px'
          }
        },
        min: 0,
        tickAmount: 5
      },
      grid: {
        borderColor: '#E5E7EB',
        strokeDashArray: 4
      },
      tooltip: {
        theme: 'light',
        x: {
          show: false
        }
      }
    };

    const purchasesElement = document.querySelector("#purchasesChart");
    if (purchasesElement) {
      const purchasesChart = new ApexCharts(purchasesElement, purchasesOptions);
      purchasesChart.render();
    } else {
      console.error('Element #purchasesChart not found');
    }

    // Daily Downloads Chart
    const downloadsOptions = {
      series: [{
        name: 'Downloads',
        data: dailyDownloadsCounts
      }],
      chart: {
        type: 'area',
        height: 300,
        toolbar: {
          show: false
        },
        animations: {
          enabled: true,
          easing: 'easeinout',
          speed: 800,
          animateGradually: {
            enabled: true,
            delay: 150
          },
          dynamicAnimation: {
            enabled: true,
            speed: 350
          }
        }
      },
      colors: ['#F56565'],
      fill: {
        type: 'gradient',
        gradient: {
          shadeIntensity: 1,
          opacityFrom: 0.7,
          opacityTo: 0.2,
          stops: [0, 90, 100]
        }
      },
      dataLabels: {
        enabled: false
      },
      stroke: {
        curve: 'smooth',
        width: 3
      },
      xaxis: {
        categories: last7DaysDisplay,
        labels: {
          style: {
            colors: '#6B7280',
            fontSize: '12px'
          }
        }
      },
      yaxis: {
        labels: {
          style: {
            colors: '#6B7280',
            fontSize: '12px'
          }
        },
        min: 0,
        tickAmount: 5
      },
      grid: {
        borderColor: '#E5E7EB',
        strokeDashArray: 4
      },
      tooltip: {
        theme: 'light',
        x: {
          show: false
        }
      }
    };

    const downloadsElement = document.querySelector("#downloadsChart");
    if (downloadsElement) {
      const downloadsChart = new ApexCharts(downloadsElement, downloadsOptions);
      downloadsChart.render();
    } else {
      console.error('Element #downloadsChart not found');
    }

    // Top Ebooks Chart
    const topEbooksOptions = {
      series: [{
        name: 'Total de envios',
        data: topEbooksCounts
      }],
      chart: {
        type: 'bar',
        height: 300,
        toolbar: {
          show: false
        },
        animations: {
          enabled: true,
          easing: 'easeinout',
          speed: 800,
          animateGradually: {
            enabled: true,
            delay: 150
          },
          dynamicAnimation: {
            enabled: true,
            speed: 350
          }
        }
      },
      colors: ['#3B82F6'],
      plotOptions: {
        bar: {
          borderRadius: 8,
          horizontal: false,
          columnWidth: '60%',
          endingShape: 'rounded'
        }
      },
      dataLabels: {
        enabled: false
      },
      stroke: {
        show: true,
        width: 2,
        colors: ['transparent']
      },
      xaxis: {
        categories: topEbooksLabels,
        labels: {
          style: {
            colors: '#6B7280',
            fontSize: '12px'
          },
          rotate: -45,
          rotateAlways: false
        }
      },
      yaxis: {
        labels: {
          style: {
            colors: '#6B7280',
            fontSize: '12px'
          }
        },
        min: 0,
        tickAmount: 5
      },
      grid: {
        borderColor: '#E5E7EB',
        strokeDashArray: 4
      },
      fill: {
        opacity: 1
      },
      tooltip: {
        theme: 'light',
        y: {
          formatter: function (val) {
            return val + " envios"
          }
        }
      }
    };

    const topEbooksElement = document.querySelector("#topEbooksChart");
    if (topEbooksElement) {
      const topEbooksChart = new ApexCharts(topEbooksElement, topEbooksOptions);
      topEbooksChart.render();
    } else {
      console.error('Element #topEbooksChart not found');
    }

    // Top Downloaded Ebooks Chart
    const topDownloadedEbooksOptions = {
      series: [{
        name: 'Total de downloads',
        data: topDownloadedEbooksCounts
      }],
      chart: {
        type: 'bar',
        height: 300,
        toolbar: {
          show: false
        },
        animations: {
          enabled: true,
          easing: 'easeinout',
          speed: 800,
          animateGradually: {
            enabled: true,
            delay: 150
          },
          dynamicAnimation: {
            enabled: true,
            speed: 350
          }
        }
      },
      colors: ['#10B981'],
      plotOptions: {
        bar: {
          borderRadius: 8,
          horizontal: false,
          columnWidth: '60%',
          endingShape: 'rounded'
        }
      },
      dataLabels: {
        enabled: false
      },
      stroke: {
        show: true,
        width: 2,
        colors: ['transparent']
      },
      xaxis: {
        categories: topDownloadedEbooksLabels,
        labels: {
          style: {
            colors: '#6B7280',
            fontSize: '12px'
          },
          rotate: -45,
          rotateAlways: false
        }
      },
      yaxis: {
        labels: {
          style: {
            colors: '#6B7280',
            fontSize: '12px'
          }
        },
        min: 0,
        tickAmount: 5
      },
      grid: {
        borderColor: '#E5E7EB',
        strokeDashArray: 4
      },
      fill: {
        opacity: 1
      },
      tooltip: {
        theme: 'light',
        y: {
          formatter: function (val) {
            return val + " downloads"
          }
        }
      }
    };

    const topDownloadedEbooksElement = document.querySelector("#topDownloadedEbooksChart");
    if (topDownloadedEbooksElement) {
      const topDownloadedEbooksChart = new ApexCharts(topDownloadedEbooksElement, topDownloadedEbooksOptions);
      topDownloadedEbooksChart.render();
    } else {
      console.error('Element #topDownloadedEbooksChart not found');
    }
  }

  // If using Chart.js fallback
  function initializeChartJS () {
    // Chart.js implementation would go here
    console.log('Using Chart.js fallback');
  }
</script>
{{end}}