{{ define "title" }}Criar Ebook{{ end }}
{{ define "content" }}
<!-- Container fluid -->
<div class="container-fluid p-6">
  <div class="row">
    <div class="col-lg-12 col-md-12 col-12">
      <!-- Page header -->
      <div class="border-bottom pb-4 mb-4">
        <div class="row align-items-center">
          <div class="col">
            <h3 class="mb-0 fw-bold">Criar Ebook</h3>
            <p class="mb-0 text-muted">Crie um ebook profissional selecionando arquivos e criando uma página de vendas atrativa</p>
          </div>
          <div class="col-auto">
            <div class="d-flex gap-2">
              <a href="/ebook" class="btn btn-outline-secondary">
                <i class="fa-solid fa-arrow-left icon-xs me-2"></i>
                Voltar
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- content -->
  <div class="py-6">
    <!-- row  -->
    <div class="row">
      <!-- card  -->
      <div class="col-xl-12 col-lg-12 col-md-12 col-12">
        <div class="card h-100">
          <!-- card body -->
          <div class="card-body">
            <form action="/ebook/create" method="POST" id="createEbookForm" enctype="multipart/form-data">
              <!-- TODO: Add CSRF TOKEN -->
              <input type="hidden" name="csrf_token" value="{{.csrf_token}}" />
              <div class="row">
                <div class="col-lg-8 main-content-column">
                  {{ template "form-errors" .}}
                    <div class="mb-4">
                      <h5 class="mb-3">
                        <i class="fa-solid fa-circle-info icon-sm me-2"></i>
                        Informações Básicas
                      </h5>
                      <div class="mb-3">
                        <label for="title" class="form-label fw-semibold">Título do Ebook <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" name="title" required placeholder="Ex: Guia Completo de Marketing Digital" value="{{.Form.Title}}"  maxlength="120">
                        <div class="form-text">
                          <i class="fa-solid fa-lightbulb icon-xs me-1"></i>
                          Crie um título atrativo que desperte interesse
                        </div>
                      </div>

                      <div class="mb-3">
                        <label for="description" class="form-label fw-semibold">Descrição Curta <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="description" name="description" rows="3" required placeholder="Descreva brevemente o que o leitor encontrará neste ebook..." maxlength="120">{{.Form.Description}}</textarea>
                        <div class="form-text">
                          <i class="fa-solid fa-circle-info icon-xs me-1"></i>
                          Máximo 120 caracteres
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="value" class="form-label fw-semibold">Preço (R$) <span class="text-danger">*</span></label>
                            <div class="input-group">
                              <span class="input-group-text">R$</span>
                              <input type="text" class="form-control money2" id="value" name="value" required placeholder="29.90" value="{{.Form.Value}}">
                            </div>
                            <div class="form-text">
                              <i class="fa-solid fa-dollar-sign icon-xs me-1"></i>
                              Defina um preço competitivo
                            </div>
                          </div>
                          <div class="mb-3">
                            <label for="value" class="form-label fw-semibold">Preço Promocional (R$)</label>
                            <div class="input-group">
                              <span class="input-group-text">R$</span>
                              <input type="text" class="form-control money2" id="promotional-value" name="promotional_value" placeholder="19.90" value="{{.Form.PromotionalValue}}">
                            </div>
                            <div class="form-text">
                              <i class="fa-solid fa-dollar-sign icon-xs me-1"></i>
                              Defina um desconto promocional
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="image" class="form-label fw-semibold">Imagem de Capa</label>
                            <input type="file" class="form-control" id="image" name="image" accept="image/*">
                            <div class="form-text">
                              <i class="fa-solid fa-image icon-xs me-1"></i>
                              Recomendado: 800x600px
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="mb-4">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">
                          <i class="fa-solid fa-plus-circle icon-sm me-2"></i>
                          Adicionar Arquivos
                        </h5>
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#fileLibraryModal">
                          <i class="fa-solid fa-plus icon-sm me-1"></i>
                          Adicionar arquivos
                        </button>
                      </div>
                      <p class="text-muted mb-0">Selecione arquivos da sua biblioteca ou faça upload diretamente dentro do modal.</p>

                      <!-- Modal: Biblioteca de Arquivos -->
                      <div class="modal fade" id="fileLibraryModal" tabindex="-1" aria-labelledby="fileLibraryModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl modal-dialog-scrollable">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="fileLibraryModalLabel">
                                <i class="fa-solid fa-book me-2"></i> Biblioteca de Arquivos
                              </h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <!-- Tabs para biblioteca e upload -->
                              <ul class="nav nav-tabs" id="modalFilesTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                  <button class="nav-link active" id="modal-library-tab" data-bs-toggle="tab" data-bs-target="#modal-library" type="button" role="tab">
                                    <i class="fa-solid fa-book icon-sm me-1"></i>Da Biblioteca
                                  </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                  <button class="nav-link" id="modal-upload-tab" data-bs-toggle="tab" data-bs-target="#modal-upload" type="button" role="tab">
                                    <i class="fa-solid fa-cloud-arrow-up icon-sm me-1"></i>Upload Direto
                                  </button>
                                </li>
                              </ul>

                              <div class="tab-content pt-3" id="modalFilesTabContent">
                                <!-- Tab: Biblioteca -->
                                <div class="tab-pane fade show active" id="modal-library" role="tabpanel">
                                  {{if .Files}}
                                  <div class="alert alert-info border-0">
                                    <div class="d-flex align-items-center">
                                      <i class="fa-solid fa-circle-info icon-sm me-2"></i>
                                      <div>
                                        <strong>Biblioteca:</strong> Selecione arquivos da sua biblioteca para incluir no ebook.
                                      </div>
                                    </div>
                                  </div>

                                  <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex gap-2">
                                      <button type="button" class="btn btn-sm btn-outline-primary" id="modalSelectAllBtn">
                                        <i class="fa-solid fa-square-check icon-xs me-1"></i>Selecionar Todos
                                      </button>
                                      <button type="button" class="btn btn-sm btn-outline-secondary" id="modalDeselectAllBtn">
                                        <i class="fa-regular fa-square icon-xs me-1"></i>Desmarcar Todos
                                      </button>
                                    </div>
                                    <div class="d-flex align-items-center gap-3">
                                      <span class="text-muted small">
                                        Selecionados: <span class="badge bg-primary" id="modalSelectedCount">0</span>
                                      </span>
                                      <div class="input-group input-group-sm" style="width: 250px;">
                                        <span class="input-group-text">
                                          <i class="fa-solid fa-magnifying-glass icon-xs"></i>
                                        </span>
                                        <input type="text" class="form-control" id="modalFileSearch" placeholder="Buscar arquivos...">
                                      </div>
                                    </div>
                                  </div>

                                  <div class="table-responsive">
                                    <table class="table table-hover text-nowrap" id="modalFilesTable">
                                      <thead class="table-light">
                                        <tr>
                                          <th width="50">
                                            <input type="checkbox" class="form-check-input" id="modalSelectAllCheckbox">
                                          </th>
                                          <th>Nome do Arquivo</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        {{range .Files}}
                                        <tr class="modal-file-row" data-filename="{{.OriginalName}}" data-type="{{.FileType}}" data-size="{{.GetFileSizeFormatted}}" data-id="{{.ID}}">
                                          <td>
                                            <input type="checkbox" class="form-check-input modal-file-checkbox" data-file-id="{{.ID}}" id="modal_file_{{.ID}}">
                                          </td>
                                          <td>
                                            <div class="d-flex align-items-center">
                                              <div class="avatar-sm me-2">
                                                {{if eq .FileType "pdf"}}
                                                <div class="avatar-title bg-danger-lighten text-danger rounded">
                                                  <i class="fa-regular fa-file-lines icon-sm"></i>
                                                </div>
                                                {{else if eq .FileType "document"}}
                                                  <div class="avatar-title bg-primary-lighten text-primary rounded">
                                                    <i class="fa-regular fa-file-lines icon-sm"></i>
                                                  </div>
                                                  {{else if eq .FileType "image"}}
                                                    <div class="avatar-title bg-success-lighten text-success rounded">
                                                      <i class="fa-regular fa-image icon-sm"></i>
                                                    </div>
                                                    {{else}}
                                                      <div class="avatar-title bg-secondary-lighten text-secondary rounded">
                                                        <i class="fa-regular fa-file icon-sm"></i>
                                                      </div>
                                                      {{end}}
                                              </div>
                                              <div>
                                                <h6 class="mb-0">{{.OriginalName}} <span class="text-muted">{{.GetFileSizeFormatted}}</span></h6>
                                                {{if .Description}}
                                                <small class="text-muted">{{.Description}}</small>
                                                {{end}}
                                              </div>
                                            </div>
                                          </td>
                                        </tr>
                                        {{end}}
                                      </tbody>
                                    </table>
                                  </div>

                                  <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div class="text-muted small">
                                      Total: <span id="modalTotalFiles">{{.Pagination.Total}}</span> arquivos disponíveis
                                    </div>
                                    <div class="text-muted small">
                                      Tamanho total selecionado: <span id="modalTotalSize">0 MB</span>
                                    </div>
                                  </div>

                                  {{if .Pagination}}
                                  {{ template "table-footer" . }}
                                  {{end}}
                                  {{else}}
                                    <div class="alert alert-info border-0">
                                      <div class="d-flex align-items-center">
                                        <i class="fa-solid fa-circle-info icon-sm me-2"></i>
                                        <div>
                                          Você ainda não tem arquivos em sua biblioteca.
                                        </div>
                                      </div>
                                    </div>
                                  {{end}}
                                </div>

                                <!-- Tab: Upload Direto -->
                                <div class="tab-pane fade" id="modal-upload" role="tabpanel">
                                  <div class="alert alert-info border-0">
                                    <div class="d-flex align-items-center">
                                      <i class="fa-solid fa-circle-info icon-sm me-2"></i>
                                      <div>
                                        <strong>Upload Direto:</strong> Envie novos arquivos diretamente do seu computador para adicionar ao ebook.
                                      </div>
                                    </div>
                                  </div>

                                  <div class="upload-area border border-2 border-dashed rounded p-4 text-center" id="modalUploadArea">
                                    <div class="mb-3">
                                      <i class="fa-solid fa-cloud-arrow-up fa-3x text-muted"></i>
                                    </div>
                                    <h5 class="mb-2">Arraste arquivos aqui ou clique para selecionar</h5>
                                    <p class="text-muted mb-3">
                                      Tipos aceitos: PDF, DOC, DOCX, JPG, PNG, GIF<br>
                                      Tamanho máximo por arquivo: 50MB
                                    </p>
                                    <input type="file" class="d-none" id="modalNewFilesInput" name="new_files" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif">
                                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('modalNewFilesInput').click()">
                                      <i class="fa-solid fa-folder-open icon-sm me-1"></i>Selecionar Arquivos
                                    </button>
                                  </div>

                                  <div id="modalUploadFilesList" class="mt-3" style="display: none;">
                                    <h6 class="fw-semibold">Arquivos Selecionados:</h6>
                                    <div id="modalUploadFilesContainer"></div>
                                    <div class="mt-3">
                                      <button type="button" class="btn btn-sm btn-outline-danger" id="modalClearUploadsBtn">
                                        <i class="fa-solid fa-trash icon-xs me-1"></i>Limpar Lista
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                              <button type="button" class="btn btn-primary" id="confirmAddFilesBtn">
                                <i class="fa-solid fa-plus icon-sm me-1"></i>Adicionar selecionados
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="mb-4">
                      <h5 class="mb-3">
                        <i class="fa-solid fa-pen-to-square icon-sm me-2"></i>
                        Página de Vendas
                      </h5>
                      <p class="text-muted mb-3">Crie uma página de vendas persuasiva que converta visitantes em compradores.</p>

                      <div class="mb-3">
                        <label for="sales_page" class="form-label fw-semibold">Conteúdo da Página de Vendas <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="sales_page" name="sales_page" rows="5" required placeholder="Escreva aqui o conteúdo da sua página de vendas...">{{.Form.SalesPage}}</textarea>
                        <div class="form-text">
                          <strong>Dicas para uma página de vendas eficaz:</strong><br>
                          • Comece com um título impactante<br>
                          • Apresente o problema que seu ebook resolve<br>
                          • Liste os benefícios e resultados<br>
                          • Inclua depoimentos ou social proof<br>
                          • Crie urgência e escassez<br>
                          • Termine com uma call-to-action clara
                        </div>
                      </div>
                    </div>
                </div>
                <div class="col-lg-4">
                  <div class="sticky-sidebar-wrapper">
                    <div class="sticky-sidebar-content">
                      <div class="mb-4">
                        <h6 class="mb-3">
                          <i class="fa-regular fa-lightbulb icon-sm me-2"></i>
                          Dicas para Ebooks de Sucesso
                        </h6>
                        <ul class="list-unstyled mb-0">
                          <li class="mb-3 d-flex align-items-start">
                            <i class="fa-solid fa-circle-check icon-sm text-success me-2 mt-1"></i>
                            <span>Escolha arquivos de qualidade</span>
                          </li>
                          <li class="mb-3 d-flex align-items-start">
                            <i class="fa-solid fa-circle-check icon-sm text-success me-2 mt-1"></i>
                            <span>Organize o conteúdo logicamente</span>
                          </li>
                          <li class="mb-3 d-flex align-items-start">
                            <i class="fa-solid fa-circle-check icon-sm text-success me-2 mt-1"></i>
                            <span>Crie uma página de vendas persuasiva</span>
                          </li>
                          <li class="mb-3 d-flex align-items-start">
                            <i class="fa-solid fa-circle-check icon-sm text-success me-2 mt-1"></i>
                            <span>Defina um preço competitivo</span>
                          </li>
                        </ul>
                      </div>

                      <div class="mb-4">
                        <h6 class="mb-3">
                          <i class="fa-regular fa-chart-bar icon-sm me-2"></i>
                          Estatísticas dos Arquivos
                        </h6>
                        <div class="row g-3">
                          <div class="col-6">
                            <div class="text-center p-2 rounded border bg-light">
                              <h3 class="mb-1 text-primary fw-bold" id="fileCount">0</h3>
                              <small class="text-muted fw-medium">Total</small>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="text-center p-2 rounded border bg-light">
                              <h3 class="mb-1 text-success fw-bold" id="totalSizeDisplay">0 B</h3>
                              <small class="text-muted fw-medium">Tamanho</small>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="text-center p-2 rounded border bg-light">
                              <h3 class="mb-1 text-info fw-bold" id="libraryCount">0</h3>
                              <small class="text-muted fw-medium">Biblioteca</small>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="text-center p-2 rounded border bg-light">
                              <h3 class="mb-1 text-warning fw-bold" id="uploadCount">0</h3>
                              <small class="text-muted fw-medium">Uploads</small>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="mb-4">
                        <div class="d-grid gap-2">
                          <button type="submit" class="btn btn-primary" id="submitBtn" form="createEbookForm">
                            <i class="fa-solid fa-plus icon-sm me-1"></i>
                            Salvar Ebook
                          </button>
                          <a href="/ebook" class="btn btn-secondary">
                            <i class="fa-solid fa-arrow-left icon-sm me-1"></i>
                            Cancelar
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Modal: Biblioteca de Arquivos (seleção, busca e upload dentro do modal) — Tela de Criação
  document.addEventListener('DOMContentLoaded', function () {
    const modalEl = document.getElementById('fileLibraryModal');
    if (!modalEl) return;

    // Referências do formulário principal
    const form = document.getElementById('createEbookForm');

    // Tabela / seleção (dentro do modal)
    const modalSelectAllCheckbox = document.getElementById('modalSelectAllCheckbox');
    const modalSelectAllBtn = document.getElementById('modalSelectAllBtn');
    const modalDeselectAllBtn = document.getElementById('modalDeselectAllBtn');
    const modalSelectedCount = document.getElementById('modalSelectedCount');
    const modalFileSearch = document.getElementById('modalFileSearch');
    const confirmAddFilesBtn = document.getElementById('confirmAddFilesBtn');

    const modalFileRows = Array.from(document.querySelectorAll('#modalFilesTable tbody .modal-file-row'));
    const modalFileCheckboxes = () => Array.from(document.querySelectorAll('.modal-file-checkbox'));

    // Upload (modal)
    const modalUploadArea = document.getElementById('modalUploadArea');
    const modalNewFilesInput = document.getElementById('modalNewFilesInput');
    const modalUploadFilesList = document.getElementById('modalUploadFilesList');
    const modalUploadFilesContainer = document.getElementById('modalUploadFilesContainer');
    const modalClearUploadsBtn = document.getElementById('modalClearUploadsBtn');

    // Sidebar KPIs (opcional na criação)
    const fileCountEl = document.getElementById('fileCount');
    const libraryCountEl = document.getElementById('libraryCount');
    const uploadCountEl = document.getElementById('uploadCount');
    const totalSizeDisplayEl = document.getElementById('totalSizeDisplay');

    let modalSelectedUploadFiles = [];

    function updateModalStats () {
      const checked = modalFileCheckboxes().filter(cb => cb.checked);
      if (modalSelectedCount) modalSelectedCount.textContent = checked.length;
      // Atualizar tamanho total estimado (2MB por arquivo da biblioteca) + uploads reais
      const estLibraryBytes = checked.length * 2 * 1024 * 1024;
      const uploadBytes = modalSelectedUploadFiles.reduce((acc, f) => acc + f.size, 0);
      const totalBytes = estLibraryBytes + uploadBytes;
      const totalSizeEl = document.getElementById('modalTotalSize');
      if (totalSizeEl) totalSizeEl.textContent = formatBytes(estLibraryBytes);

      // Atualizar KPIs da sidebar
      const totalFiles = checked.length + modalSelectedUploadFiles.length;
      if (fileCountEl) fileCountEl.textContent = totalFiles;
      if (libraryCountEl) libraryCountEl.textContent = checked.length;
      if (uploadCountEl) uploadCountEl.textContent = modalSelectedUploadFiles.length;
      if (totalSizeDisplayEl) totalSizeDisplayEl.textContent = formatBytes(totalBytes);
    }

    // Selecionar/Deselecionar todos
    if (modalSelectAllCheckbox) {
      modalSelectAllCheckbox.addEventListener('change', function () {
        modalFileCheckboxes().forEach(cb => cb.checked = this.checked);
        updateModalStats();
      });
    }
    if (modalSelectAllBtn) {
      modalSelectAllBtn.addEventListener('click', function () {
        modalFileCheckboxes().forEach(cb => cb.checked = true);
        if (modalSelectAllCheckbox) modalSelectAllCheckbox.checked = true;
        updateModalStats();
      });
    }
    if (modalDeselectAllBtn) {
      modalDeselectAllBtn.addEventListener('click', function () {
        modalFileCheckboxes().forEach(cb => cb.checked = false);
        if (modalSelectAllCheckbox) modalSelectAllCheckbox.checked = false;
        updateModalStats();
      });
    }

    // Mudança individual
    modalFileRows.forEach(row => {
      const cb = row.querySelector('.modal-file-checkbox');
      if (cb) cb.addEventListener('change', updateModalStats);
    });

    // Busca com debounce no modal
    if (modalFileSearch) {
      let t;
      modalFileSearch.addEventListener('input', function () {
        clearTimeout(t);
        t = setTimeout(() => {
          const term = this.value.trim().toLowerCase();
          modalFileRows.forEach(row => {
            const name = (row.getAttribute('data-filename') || '').toLowerCase();
            const type = (row.getAttribute('data-type') || '').toLowerCase();
            row.style.display = (name.includes(term) || type.includes(term)) ? '' : 'none';
          });
        }, 300);
      });
    }

    // Upload dentro do modal
    if (modalUploadArea && modalNewFilesInput) {
      // Drag & drop
      modalUploadArea.addEventListener('dragover', function (e) {
        e.preventDefault();
        modalUploadArea.classList.add('border-primary', 'bg-light');
      });
      modalUploadArea.addEventListener('dragleave', function (e) {
        e.preventDefault();
        modalUploadArea.classList.remove('border-primary', 'bg-light');
      });
      modalUploadArea.addEventListener('drop', function (e) {
        e.preventDefault();
        modalUploadArea.classList.remove('border-primary', 'bg-light');
        const files = Array.from(e.dataTransfer.files);
        handleModalUploadSelection(files);
      });
      modalNewFilesInput.addEventListener('change', function (e) {
        const files = Array.from(e.target.files);
        handleModalUploadSelection(files);
      });
    }

    function handleModalUploadSelection (files) {
      const allowedTypes = ['application/pdf', 'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
      const allowedExtensions = ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.gif'];
      const maxSize = 50 * 1024 * 1024;
      files.forEach(file => {
        const ext = '.' + (file.name.split('.').pop() || '').toLowerCase();
        const typeOk = !!file.type ? allowedTypes.includes(file.type) : allowedExtensions.includes(ext);
        if (!typeOk) return;
        if (file.size > maxSize) return;
        if (modalSelectedUploadFiles.find(f => f.name === file.name && f.size === file.size)) return;
        modalSelectedUploadFiles.push(file);
      });
      renderModalUploadList();
    }

    function renderModalUploadList () {
      if (!modalUploadFilesList) return;
      if (modalSelectedUploadFiles.length === 0) {
        modalUploadFilesList.style.display = 'none';
        // Sincronizar input vazio
        if (modalNewFilesInput) modalNewFilesInput.value = '';
        updateModalStats();
        return;
      }
      modalUploadFilesList.style.display = 'block';
      if (modalUploadFilesContainer) {
        modalUploadFilesContainer.innerHTML = '';
        modalSelectedUploadFiles.forEach((file, index) => {
          const el = document.createElement('div');
          el.className = 'border rounded p-2 mb-2';
          el.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <i class="fa-regular fa-file icon-sm me-2"></i>
                <div>
                  <div class="fw-semibold">${file.name}</div>
                  <small class="text-muted">${formatBytes(file.size)}</small>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-danger" data-remove-index="${index}">
                <i class="fa-solid fa-trash icon-xs"></i>
              </button>
            </div>`;
          modalUploadFilesContainer.appendChild(el);
          el.querySelector('button[data-remove-index]')?.addEventListener('click', () => {
            modalSelectedUploadFiles.splice(index, 1);
            renderModalUploadList();
          });
        });
      }
      // Sincronizar com input de arquivo do modal (para submissão no form principal)
      const dt = new DataTransfer();
      modalSelectedUploadFiles.forEach(f => dt.items.add(f));
      if (modalNewFilesInput) modalNewFilesInput.files = dt.files;
      updateModalStats();
    }

    if (modalClearUploadsBtn) {
      modalClearUploadsBtn.addEventListener('click', function () {
        modalSelectedUploadFiles = [];
        renderModalUploadList();
      });
    }

    function formatBytes (bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Confirmar seleção: criar inputs hidden e atualizar listagem visual
    if (confirmAddFilesBtn) {
      confirmAddFilesBtn.addEventListener('click', function () {
        if (!form) return;

        const container = ensureCurrentFilesContainer();

        // 1) IDs da biblioteca
        const checked = modalFileCheckboxes().filter(cb => cb.checked);
        checked.forEach(cb => {
          const fileId = cb.getAttribute('data-file-id');
          // Evitar duplicidade de inputs
          if (!form.querySelector(`input.dynamic-new-file-input[value="${fileId}"]`)) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'new_files';
            input.value = fileId;
            input.className = 'dynamic-new-file-input';
            form.appendChild(input);
          }

          // Adicionar visualmente no container de arquivos selecionados
          const row = cb.closest('tr');
          if (!row) return;
          const existingCard = container.querySelector(`.file-card[data-file-id="${fileId}"]`);
          if (existingCard) return; // já listado

          const filename = row.getAttribute('data-filename') || 'Arquivo';
          const filetype = row.getAttribute('data-type') || 'file';
          const size = row.getAttribute('data-size') || '';

          const col = document.createElement('div');
          col.className = 'col-md-6 mb-3';
          col.innerHTML = createFileCardHtml(fileId, filename, filetype, size);
          container.appendChild(col);
        });

        // 2) Uploads selecionados no modal: renderizar cartões (o envio já está garantido via #modalNewFilesInput)
        if (Array.isArray(modalSelectedUploadFiles) && modalSelectedUploadFiles.length > 0) {
          modalSelectedUploadFiles.forEach(file => {
            const pseudoId = `upload:${file.name}:${file.size}`;
            if (container.querySelector(`.file-card[data-upload-id="${CSS.escape(pseudoId)}"]`)) return;
            const ext = (file.name.split('.').pop() || '').toLowerCase();
            const filetype = (ext === 'pdf') ? 'pdf' : (['doc','docx'].includes(ext) ? 'document' : (['jpg','jpeg','png','gif'].includes(ext) ? 'image' : 'file'));
            const typeClass = filetype === 'pdf' ? 'bg-danger-lighten text-danger' : (filetype === 'document' ? 'bg-primary-lighten text-primary' : (filetype === 'image' ? 'bg-success-lighten text-success' : 'bg-secondary-lighten text-secondary'));
            const icon = filetype === 'image' ? 'fa-regular fa-image' : 'fa-regular fa-file-lines';
            const col = document.createElement('div');
            col.className = 'col-md-6 mb-3';
            col.innerHTML = `
              <div class=\"card file-card h-100 border-warning\" data-upload-id=\"${pseudoId}\" data-upload-name=\"${file.name}\" data-upload-size=\"${file.size}\">\n                <div class=\"card-body\">\n                  <div class=\"d-flex align-items-center mb-2\">\n                    <div class=\"avatar-sm me-2\">\n                      <div class=\"avatar-title ${typeClass} rounded\">\n                        <i class=\"${icon} icon-sm\"></i>\n                      </div>\n                    </div>\n                    <div class=\"flex-grow-1\">\n                      <h6 class=\"mb-0\">${file.name}</h6>\n                      <small class=\"text-muted\">${formatBytes(file.size)}</small>\n                    </div>\n                    <div class=\"d-flex align-items-center gap-2 ms-2\">\n                      <span class=\"badge bg-warning\">\n                        <i class=\"fa-solid fa-clock icon-xs me-1\"></i>Pendente\n                      </span>\n                      <button type=\"button\" class=\"btn btn-sm btn-outline-danger remove-selected-file\" title=\"Remover\">\n                        <i class=\"fa-solid fa-trash icon-xs\"></i>\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              </div>`;
            container.appendChild(col);
          });
        }

        // Fechar modal
        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
        modalInstance.hide();
      });
    }

    function ensureCurrentFilesContainer () {
      let container = document.getElementById('currentFilesContainer');
      if (!container) {
        // Criar seção de exibição dos arquivos selecionados
        const section = document.createElement('div');
        section.className = 'row';
        section.id = 'currentFilesContainer';
        // Inserir após o bloco de "Adicionar Arquivos"
        const addSection = modalEl.closest('.mb-4');
        if (addSection && addSection.parentElement) {
          addSection.parentElement.insertBefore(section, addSection.nextSibling);
        } else if (form) {
          form.appendChild(section);
        } else {
          document.body.appendChild(section);
        }
        container = section;
      }
      return container;
    }

    function createFileCardHtml (fileId, filename, filetype, size) {
      const typeClass = filetype === 'pdf' ? 'bg-danger-lighten text-danger' : (filetype === 'document' ? 'bg-primary-lighten text-primary' : (filetype === 'image' ? 'bg-success-lighten text-success' : 'bg-secondary-lighten text-secondary'));
      const icon = filetype === 'image' ? 'fa-regular fa-image' : 'fa-regular fa-file-lines';
      return `
        <div class="card file-card h-100 border-warning" data-file-id="${fileId}">
          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <div class="avatar-sm me-2">
                <div class="avatar-title ${typeClass} rounded">
                  <i class="${icon} icon-sm"></i>
                </div>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-0">${filename}</h6>
                <small class="text-muted">${size}</small>
              </div>
              <div class="d-flex align-items-center gap-2 ms-2">
                <span class="badge bg-warning">
                  <i class="fa-solid fa-clock icon-xs me-1"></i>Pendente
                </span>
                <button type="button" class="btn btn-sm btn-outline-danger remove-selected-file" title="Remover">
                  <i class="fa-solid fa-trash icon-xs"></i>
                </button>
              </div>
            </div>
          </div>
        </div>`;
    }

    // Remoção via ícone de lixeira nos cartões (biblioteca e uploads)
    document.addEventListener('click', function (e) {
      const btn = e.target.closest?.('.remove-selected-file');
      if (!btn) return;
      const card = btn.closest('.file-card');
      if (!card) return;
      const col = card.closest('.col-md-6');

      // 1) Arquivo da biblioteca (tem data-file-id)
      const fileId = card.getAttribute('data-file-id');
      if (fileId) {
        if (form) {
          const selector = `input.dynamic-new-file-input[name="new_files"][value="${CSS.escape(fileId)}"]`;
          form.querySelectorAll(selector).forEach(el => el.remove());
        }
        const cb = document.querySelector(`.modal-file-checkbox[data-file-id="${CSS.escape(fileId)}"]`);
        if (cb) cb.checked = false;
        if (col) col.remove();
        updateModalStats();
        return;
      }

      // 2) Upload pendente (usa nome + tamanho)
      const uploadName = card.getAttribute('data-upload-name');
      const uploadSize = parseInt(card.getAttribute('data-upload-size') || '0', 10);
      if (uploadName && !isNaN(uploadSize)) {
        modalSelectedUploadFiles = modalSelectedUploadFiles.filter(f => !(f.name === uploadName && f.size === uploadSize));
        renderModalUploadList();
        if (col) col.remove();
        updateModalStats();
      }
    });

    // Resetar contadores quando o modal abrir
    modalEl.addEventListener('shown.bs.modal', () => {
      updateModalStats();
    });
  });

  // Visualização de arquivo (abre nova aba)
  function previewFile (fileId, fileName) {
    window.open(`/file/preview/${fileId}`, '_blank');
  }

  // Validação do formulário na criação
  document.getElementById('createEbookForm')?.addEventListener('submit', function (e) {
    const submitBtn = document.getElementById('submitBtn');
    const hasHiddenIds = this.querySelectorAll('input[name="new_files"].dynamic-new-file-input').length > 0;
    const modalUpload = document.getElementById('modalNewFilesInput');
    const hasUploads = modalUpload && modalUpload.files && modalUpload.files.length > 0;

    if (!hasHiddenIds && !hasUploads) {
      e.preventDefault();
      alert('Por favor, selecione arquivos da biblioteca ou faça upload de novos arquivos.');
      return;
    }

    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fa-solid fa-spinner icon-sm me-1 animate-spin"></i> Criando Ebook...';
    }
  });
</script>
{{end}}