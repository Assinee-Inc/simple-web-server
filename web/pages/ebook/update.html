{{ define "title" }}Editar Ebook{{ end }}
{{ define "content" }}
<!-- Container fluid -->
<div class="container-fluid p-6">
  <div class="row">
    <div class="col-lg-12 col-md-12 col-12">
      <!-- Page header -->
      <div class="border-bottom pb-4 mb-4">
        <div class="row align-items-center">
          <div class="col">
            <h3 class="mb-0 fw-bold">Editar Ebook</h3>
            <p class="mb-0 text-muted">Atualize as informações e gerencie os arquivos do seu ebook</p>
          </div>
          <div class="col-auto">
            <div class="d-flex gap-2">
              <a href="/ebook" class="btn btn-outline-secondary">
                <i class="fa-solid fa-arrow-left icon-xs me-2"></i>
                Voltar
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- content -->
  <div class="py-6">
    <!-- row  -->
    <div class="row">
      <!-- card  -->
      <div class="col-xl-12 col-lg-12 col-md-12 col-12">
        <div class="card h-100">
          <!-- card body -->
          <div class="card-body">
            <form action="/ebook/update/{{.Data.ebook.ID}}" method="POST" id="updateEbookForm" enctype="multipart/form-data">
              <div class="row">
                <div class="col-lg-8">
                  <div class="mb-4">
                    <h5 class="mb-3">
                      <i class="fa-solid fa-circle-info icon-sm me-2"></i>
                      Informações Básicas
                    </h5>
                    <!-- Informações Básicas -->
                    <div class="card border-0 shadow-sm mb-4">
                      <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                          <i class="fa-solid fa-circle-info icon-sm me-2"></i>
                          Informações Básicas
                        </h5>
                      </div>
                      <div class="card-body">
                        <div class="mb-3">
                          <label for="title" class="form-label fw-semibold">Título do Ebook <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" id="title" name="title" required 
                                 placeholder="Ex: Guia Completo de Marketing Digital"
                                 value="{{if .Form.Title}}{{.Form.Title}}{{else}}{{.Data.ebook.Title}}{{end}}">
                          <div class="form-text">
                            <i class="fa-solid fa-lightbulb icon-xs me-1"></i>
                            Crie um título atrativo que desperte interesse
                          </div>
                          {{with .Errors.Title}}
                          <div class="text-danger small mt-1">
                            <i class="fa-solid fa-circle-exclamation icon-xs me-1"></i>{{.}}
                          </div>
                          {{end}}
                        </div>

                        <div class="mb-3">
                          <label for="description" class="form-label fw-semibold">Descrição Curta <span class="text-danger">*</span></label>
                          <textarea class="form-control" id="description" name="description" rows="3" required
                                    placeholder="Descreva brevemente o que o leitor encontrará neste ebook...">{{if .Form.Description}}{{.Form.Description}}{{else}}{{.Data.ebook.Description}}{{end}}</textarea>
                          <div class="form-text">
                            <i class="fa-solid fa-circle-info icon-xs me-1"></i>
                            Máximo 120 caracteres
                          </div>
                          {{with .Errors.Description}}
                          <div class="text-danger small mt-1">
                            <i class="fa-solid fa-circle-exclamation icon-xs me-1"></i>{{.}}
                          </div>
                          {{end}}
                        </div>

                        <div class="row">
                          <div class="col-md-6">
                            <div class="mb-3">
                              <label for="value" class="form-label fw-semibold">Preço (R$) <span class="text-danger">*</span></label>
                              <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="value" name="value" step="0.01" min="0" required
                                       placeholder="29.90"
                                       value="{{if .Form.Value}}{{.Form.Value}}{{else}}{{.Data.ebook.Value}}{{end}}">
                              </div>
                              <div class="form-text">
                                <i class="fa-solid fa-dollar-sign icon-xs me-1"></i>
                                Defina um preço competitivo
                              </div>
                              {{with .Errors.Value}}
                              <div class="text-danger small mt-1">
                                <i class="fa-solid fa-circle-exclamation icon-xs me-1"></i>{{.}}
                              </div>
                              {{end}}
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="mb-3">
                              <label for="image" class="form-label fw-semibold">Imagem de Capa</label>
                              <input type="file" class="form-control" id="image" name="image" accept="image/*">
                              <div class="form-text">
                                <i class="fa-solid fa-image icon-xs me-1"></i>
                                Recomendado: 800x600px
                              </div>
                              
                              <!-- Preview da capa atual -->
                              {{if .Data.ebook.Image}}
                              <div class="mt-3">
                                <label class="form-label fw-semibold text-muted">Capa Atual:</label>
                                <div class="d-flex align-items-center">
                                  <div class="me-3">
                                    <img src="/ebook/{{.Data.ebook.ID}}/image" alt="Capa atual do ebook" 
                                         class="rounded shadow-sm" style="width: 80px; height: 80px; object-fit: cover;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                  </div>
                                  <div class="flex-grow-1">
                                    <small class="text-muted d-block">
                                      <i class="fa-solid fa-circle-info icon-xs me-1"></i>
                                      Selecione uma nova imagem para substituir a capa atual
                                    </small>
                                    <small class="text-muted d-block">
                                      <i class="fa-solid fa-link-slash icon-xs me-1"></i>
                                      URL: 
                                      <a href="/ebook/{{.Data.ebook.ID}}/image" target="_blank" class="text-truncate d-inline-block" style="max-width: 220px; vertical-align: middle;" title="/ebook/{{.Data.ebook.ID}}/image">
                                        /ebook/{{.Data.ebook.ID}}/image
                                      </a>
                                    </small>
                                  </div>
                                </div>
                              </div>
                              {{else}}
                              <div class="mt-3">
                                <label class="form-label fw-semibold text-muted">Capa Atual:</label>
                                <div class="d-flex align-items-center">
                                  <div class="me-3">
                                    <div class="bg-light border rounded d-flex align-items-center justify-content-center" 
                                         style="width: 80px; height: 80px;">
                                      <i class="fa-solid fa-file-lines text-muted" style="font-size: 1.5rem;"></i>
                                    </div>
                                  </div>
                                  <div class="flex-grow-1">
                                    <small class="text-muted d-block">
                                      <i class="fa-solid fa-circle-info icon-xs me-1"></i>
                                      Nenhuma capa definida. Selecione uma imagem para adicionar uma capa
                                    </small>
                                  </div>
                                </div>
                              </div>
                              {{end}}
                            </div>
                          </div>
                        </div>

                        <div class="mb-3">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="status" value="true" id="status" 
                                   {{if .Form.Status}}checked{{else}}{{if .Data.ebook.Status}}checked{{end}}{{end}}>
                            <label class="form-check-label fw-semibold" for="status">
                              <i class="fa-solid fa-toggle-on icon-xs me-1"></i>
                              Ebook ativo (disponível para venda)
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="mb-4">
                    <h5 class="mb-3">
                      <i class="fa-solid fa-folder icon-sm me-2"></i>
                      Arquivos Atuais do Ebook
                    </h5>
                    <!-- Arquivos Atuais -->
                    <div class="card border-0 shadow-sm mb-4">
                      <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                          <i class="fa-solid fa-folder icon-sm me-2"></i>
                          Arquivos Atuais do Ebook
                        </h5>
                      </div>
                      <div class="card-body">
                        {{if .Data.ebook.Files}}
                        <div class="alert alert-info border-0">
                          <div class="d-flex align-items-center">
                            <i class="fa-solid fa-circle-info icon-sm me-2"></i>
                            <div>
                              <strong>Arquivos atuais:</strong> Estes são os arquivos atualmente associados ao seu ebook.
                            </div>
                          </div>
                        </div>
                        
                        <div class="row" id="currentFilesContainer">
                          {{range .Data.ebook.Files}}
                          <div class="col-md-6 mb-3">
                            <div class="card file-card h-100 border-success">
                              <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                  <div class="avatar-sm me-2">
                                    {{if eq .FileType "pdf"}}
                                    <div class="avatar-title bg-danger-lighten text-danger rounded">
                                      <i class="fa-regular fa-file-lines icon-sm"></i>
                                    </div>
                                    {{else if eq .FileType "document"}}
                                    <div class="avatar-title bg-primary-lighten text-primary rounded">
                                      <i class="fa-regular fa-file-lines icon-sm"></i>
                                    </div>
                                    {{else if eq .FileType "image"}}
                                    <div class="avatar-title bg-success-lighten text-success rounded">
                                      <i class="fa-regular fa-image icon-sm"></i>
                                    </div>
                                    {{else}}
                                    <div class="avatar-title bg-secondary-lighten text-secondary rounded">
                                      <i class="fa-regular fa-file icon-sm"></i>
                                    </div>
                                    {{end}}
                                  </div>
                                  <div class="flex-grow-1">
                                    <h6 class="mb-0">{{.OriginalName}}</h6>
                                    <small class="text-muted">{{.GetFileSizeFormatted}}</small>
                                  </div>
                                  <div class="ms-2">
                                                                  <span class="badge bg-success">
                                    <i class="fa-solid fa-check icon-xs me-1"></i>Ativo
                                  </span>
                                  </div>
                                </div>
                                {{if .Description}}
                                <p class="text-muted small mb-0">{{.Description}}</p>
                                {{end}}
                              </div>
                            </div>
                          </div>
                          {{end}}
                        </div>
                        {{else}}
                        <div class="alert alert-warning border-0">
                          <div class="d-flex align-items-center">
                            <i class="fa-solid fa-triangle-exclamation icon-sm me-2"></i>
                            <div>
                              Este ebook não possui arquivos associados.
                            </div>
                          </div>
                        </div>
                        {{end}}
                      </div>
                    </div>
                  </div>

                  <div class="mb-4">
                    <h5 class="mb-3">
                      <i class="fa-solid fa-plus-circle icon-sm me-2"></i>
                      Adicionar Novos Arquivos da Biblioteca
                    </h5>
                    <!-- Adicionar Novos Arquivos -->
                    <div class="card border-0 shadow-sm mb-4">
                      <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                          <i class="fa-solid fa-plus-circle icon-sm me-2"></i>
                          Adicionar Novos Arquivos da Biblioteca
                        </h5>
                      </div>
                      <div class="card-body">
                        {{if .Data.AvailableFiles}}
                        <div class="alert alert-info border-0">
                          <div class="d-flex align-items-center">
                            <i class="fa-solid fa-circle-info icon-sm me-2"></i>
                            <div>
                              <strong>Dica:</strong> Selecione arquivos adicionais da sua biblioteca para incluir no ebook.
                            </div>
                          </div>
                        </div>
                        
                        <!-- Controles de Seleção -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                          <div class="d-flex gap-2">
                                                        <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllNewBtn">
                                <i class="fa-solid fa-square-check icon-xs me-1"></i>Selecionar Todos
                              </button>
                              <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllNewBtn">
                                <i class="fa-regular fa-square icon-xs me-1"></i>Desmarcar Todos
                              </button>
                          </div>
                          <div class="d-flex align-items-center gap-3">
                            <span class="text-muted small">
                              Selecionados: <span class="badge bg-primary" id="selectedNewCount">0</span>
                            </span>
                            <div class="input-group input-group-sm" style="width: 250px;">
                              <span class="input-group-text">
                                <i class="fa-solid fa-magnifying-glass icon-xs"></i>
                              </span>
                              <input type="text" class="form-control" id="newFileSearch" placeholder="Buscar arquivos...">
                            </div>
                          </div>
                        </div>
                        
                        <!-- Tabela de Arquivos -->
                        <div class="table-responsive">
                          <table class="table table-hover text-nowrap" id="newFilesTable">
                            <thead class="table-light">
                              <tr>
                                <th width="50">
                                  <input type="checkbox" class="form-check-input" id="selectAllNewCheckbox">
                                </th>
                                <th width="60">Tipo</th>
                                <th>Nome do Arquivo</th>
                                <th width="100">Tamanho</th>
                                <th width="120">Data</th>
                                <th width="100">Ações</th>
                              </tr>
                            </thead>
                            <tbody>
                              {{range .Data.AvailableFiles}}
                              <tr class="new-file-row" data-filename="{{.OriginalName}}" data-type="{{.FileType}}">
                                <td>
                                  <input type="checkbox" class="form-check-input new-file-checkbox" 
                                         name="new_files" value="{{.ID}}" id="new_file_{{.ID}}">
                                </td>
                                <td>
                                  {{if eq .FileType "pdf"}}
                                  <span class="badge bg-danger">
                                    <i class="fa-regular fa-file-lines icon-xs me-1"></i>PDF
                                  </span>
                                  {{else if eq .FileType "document"}}
                                  <span class="badge bg-primary">
                                    <i class="fa-regular fa-file-lines icon-xs me-1"></i>DOC
                                  </span>
                                  {{else if eq .FileType "image"}}
                                  <span class="badge bg-success">
                                    <i class="fa-regular fa-image icon-xs me-1"></i>IMG
                                  </span>
                                  {{else}}
                                  <span class="badge bg-secondary">
                                    <i class="fa-regular fa-file icon-xs me-1"></i>FILE
                                  </span>
                                  {{end}}
                                </td>
                                <td>
                                  <div class="d-flex align-items-center">
                                    <div class="avatar-sm me-2">
                                      {{if eq .FileType "pdf"}}
                                      <div class="avatar-title bg-danger-lighten text-danger rounded">
                                        <i class="fa-regular fa-file-lines icon-sm"></i>
                                      </div>
                                      {{else if eq .FileType "document"}}
                                      <div class="avatar-title bg-primary-lighten text-primary rounded">
                                        <i class="fa-regular fa-file-lines icon-sm"></i>
                                      </div>
                                      {{else if eq .FileType "image"}}
                                      <div class="avatar-title bg-success-lighten text-success rounded">
                                        <i class="fa-regular fa-image icon-sm"></i>
                                      </div>
                                      {{else}}
                                      <div class="avatar-title bg-secondary-lighten text-secondary rounded">
                                        <i class="fa-regular fa-file icon-sm"></i>
                                      </div>
                                      {{end}}
                                    </div>
                                    <div>
                                      <h6 class="mb-0">{{.OriginalName}}</h6>
                                      {{if .Description}}
                                      <small class="text-muted">{{.Description}}</small>
                                      {{end}}
                                    </div>
                                  </div>
                                </td>
                                <td>
                                  <span class="text-muted">{{.GetFileSizeFormatted}}</span>
                                </td>
                                <td>
                                  <small class="text-muted">{{.CreatedAt.Format "02/01/2006"}}</small>
                                </td>
                                <td>
                                  <button type="button" class="btn btn-sm btn-outline-info" 
                                          onclick="previewFile('{{.ID}}', '{{.OriginalName}}')" 
                                          title="Visualizar">
                                    <i class="fa-solid fa-eye icon-xs"></i>
                                  </button>
                                </td>
                              </tr>
                              {{end}}
                            </tbody>
                          </table>
                        </div>
                        
                        <!-- Estatísticas -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                          <div class="text-muted small">
                            Total: <span id="totalNewFiles">{{.Data.Pagination.Total}}</span> arquivos disponíveis
                          </div>
                          <div class="text-muted small">
                            Tamanho total selecionado: <span id="totalNewSize">0 MB</span>
                          </div>
                        </div>

                        <!-- Paginação -->
                        {{if .Data.Pagination}}
                        {{ template "table-footer" . }}
                        {{end}}
                        {{else}}
                        <div class="alert alert-info border-0">
                          <div class="d-flex align-items-center">
                            <i class="fa-solid fa-circle-info icon-sm me-2"></i>
                            <div>
                              Todos os arquivos da sua biblioteca já estão associados a este ebook.
                              <a href="/file/upload" class="alert-link fw-semibold">Faça upload de novos arquivos</a> para adicionar mais conteúdo.
                            </div>
                          </div>
                        </div>
                        {{end}}
                      </div>
                    </div>
                  </div>

                  <div class="mb-4">
                    <h5 class="mb-3">
                      <i class="fa-solid fa-pen-to-square icon-sm me-2"></i>
                      Página de Vendas
                    </h5>
                    <!-- Página de Vendas -->
                    <div class="card border-0 shadow-sm mb-4">
                      <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                          <i class="fa-solid fa-pen-to-square icon-sm me-2"></i>
                          Página de Vendas
                        </h5>
                      </div>
                      <div class="card-body">
                        <p class="text-muted mb-3">Atualize o conteúdo da sua página de vendas para melhorar as conversões.</p>
                        
                        <div class="mb-3">
                          <label for="sales_page" class="form-label fw-semibold">Conteúdo da Página de Vendas <span class="text-danger">*</span></label>
                          <textarea class="form-control" id="sales_page" name="sales_page" rows="15" required
                                    placeholder="Escreva aqui o conteúdo da sua página de vendas...">{{if .Form.SalesPage}}{{.Form.SalesPage}}{{else}}{{.Data.ebook.SalesPage}}{{end}}</textarea>
                          <div class="form-text">
                            <strong>Dicas para uma página de vendas eficaz:</strong><br>
                            • Comece com um título impactante<br>
                            • Apresente o problema que seu ebook resolve<br>
                            • Liste os benefícios e resultados<br>
                            • Inclua depoimentos ou social proof<br>
                            • Crie urgência e escassez<br>
                            • Termine com uma call-to-action clara
                          </div>
                          {{with .Errors.SalesPage}}
                          <div class="text-danger small mt-1">
                            <i class="fa-solid fa-circle-exclamation icon-xs me-1"></i>{{.}}
                          </div>
                          {{end}}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-lg-4">
                  <div class="mb-4">
                    <h6 class="mb-3">
                      <i class="fa-regular fa-lightbulb icon-sm me-2"></i>
                      Dicas para Ebooks de Sucesso
                    </h6>
                    <!-- Dicas -->
                    <div class="card border-0 shadow-sm mb-4">
                      <div class="card-header bg-transparent">
                        <h6 class="mb-0">
                          <i class="fa-regular fa-lightbulb icon-sm me-2"></i>
                          Dicas para Ebooks de Sucesso
                        </h6>
                      </div>
                      <div class="card-body">
                        <ul class="list-unstyled mb-0">
                          <li class="mb-3 d-flex align-items-start">
                            <i class="fa-solid fa-circle-check icon-sm text-success me-2 mt-1"></i>
                            <span>Mantenha o conteúdo atualizado</span>
                          </li>
                          <li class="mb-3 d-flex align-items-start">
                            <i class="fa-solid fa-circle-check icon-sm text-success me-2 mt-1"></i>
                            <span>Organize os arquivos logicamente</span>
                          </li>
                          <li class="mb-3 d-flex align-items-start">
                            <i class="fa-solid fa-circle-check icon-sm text-success me-2 mt-1"></i>
                            <span>Melhore a página de vendas</span>
                          </li>
                          <li class="mb-3 d-flex align-items-start">
                            <i class="fa-solid fa-circle-check icon-sm text-success me-2 mt-1"></i>
                            <span>Ajuste o preço conforme necessário</span>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="mb-4">
                    <h6 class="mb-3">
                      <i class="fa-regular fa-chart-bar icon-sm me-2"></i>
                      Estatísticas do Ebook
                    </h6>
                    <!-- Estatísticas -->
                    <div class="card border-0 shadow-sm mb-4">
                      <div class="card-header bg-transparent">
                        <h6 class="mb-0">
                          <i class="fa-regular fa-chart-bar icon-sm me-2"></i>
                          Estatísticas do Ebook
                        </h6>
                      </div>
                      <div class="card-body">
                        <div class="row g-2">
                          <div class="col-6">
                            <div class="text-center p-3 rounded border bg-light">
                              <h4 class="mb-1 text-primary fw-bold">{{.Data.ebook.GetFileCount}}</h4>
                              <small class="text-muted fw-medium">Arquivos</small>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="text-center p-3 rounded border bg-light">
                              <h4 class="mb-1 text-info fw-bold">{{.Data.ebook.Views}}</h4>
                              <small class="text-muted fw-medium">Visualizações</small>
                            </div>
                          </div>
                        </div>
                        <div class="row g-2 mt-1">
                          <div class="col-6">
                            <div class="text-center p-3 rounded border bg-light">
                              <h4 class="mb-1 text-warning fw-bold">{{.Data.ebook.Sales}}</h4>
                              <small class="text-muted fw-medium">Vendas</small>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="text-center p-3 rounded border bg-light">
                              <h4 class="mb-1 text-success fw-bold">{{.Data.ebook.GetValue}}</h4>
                              <small class="text-muted fw-medium">Preço</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div>
                    <!-- Ações -->
                    <div class="card border-0 shadow-sm">
                      <div class="card-body">
                        <div class="d-grid gap-2">
                          <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fa-solid fa-save icon-sm me-1"></i>
                            Atualizar Ebook
                          </button>
                          <a href="/ebook" class="btn btn-secondary">
                            <i class="fa-solid fa-arrow-left icon-sm me-1"></i>
                            Cancelar
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Funcionalidades da tabela de novos arquivos
document.addEventListener('DOMContentLoaded', function() {
    // Elementos da tabela de novos arquivos
    const selectAllNewCheckbox = document.getElementById('selectAllNewCheckbox');
    const newFileCheckboxes = document.querySelectorAll('.new-file-checkbox');
    const selectAllNewBtn = document.getElementById('selectAllNewBtn');
    const deselectAllNewBtn = document.getElementById('deselectAllNewBtn');
    const newFileSearch = document.getElementById('newFileSearch');
    const newFileRows = document.querySelectorAll('.new-file-row');
    
    // Selecionar/Deselecionar todos os novos arquivos
    if (selectAllNewCheckbox) {
        selectAllNewCheckbox.addEventListener('change', function() {
            newFileCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateNewStats();
        });
    }
    
    if (selectAllNewBtn) {
        selectAllNewBtn.addEventListener('click', function() {
            newFileCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            if (selectAllNewCheckbox) selectAllNewCheckbox.checked = true;
            updateNewStats();
        });
    }
    
    if (deselectAllNewBtn) {
        deselectAllNewBtn.addEventListener('click', function() {
            newFileCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            if (selectAllNewCheckbox) selectAllNewCheckbox.checked = false;
            updateNewStats();
        });
    }
    
    // Busca de novos arquivos com debounce
    if (newFileSearch) {
        let searchTimeout;
        newFileSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = this.value.toLowerCase();
                newFileRows.forEach(row => {
                    const filename = row.getAttribute('data-filename').toLowerCase();
                    const type = row.getAttribute('data-type').toLowerCase();
                    const isVisible = filename.includes(searchTerm) || type.includes(searchTerm);
                    row.style.display = isVisible ? '' : 'none';
                });
            }, 300);
        });
    }
    
    // Atualizar estatísticas quando checkboxes mudam
    newFileCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateNewStats);
    });
    
    // Função para atualizar estatísticas dos novos arquivos
    function updateNewStats() {
        const currentFiles = parseInt('{{.Data.ebook.GetFileCount}}') || 0;
        const selectedNewFiles = document.querySelectorAll('.new-file-checkbox:checked');
        const selectedNewCount = selectedNewFiles.length;
        const totalFiles = currentFiles + selectedNewCount;
        
        // Atualizar contadores
        const selectedNewCountElement = document.getElementById('selectedNewCount');
        if (selectedNewCountElement) selectedNewCountElement.textContent = selectedNewCount;
        
        // Atualizar sidebar
        const fileCountElement = document.querySelector('.card-body h4');
        if (fileCountElement) fileCountElement.textContent = totalFiles;
        
        // Calcular tamanho total dos novos arquivos selecionados
        const totalNewSize = selectedNewCount * 2; // Estimativa de 2MB por arquivo
        const totalNewSizeElement = document.getElementById('totalNewSize');
        if (totalNewSizeElement) totalNewSizeElement.textContent = totalNewSize + ' MB';
    }
    
    // Inicializar estatísticas
    updateNewStats();
});

// Função para visualizar arquivo
function previewFile(fileId, fileName) {
    // Abrir em nova aba ou modal
    window.open(`/file/preview/${fileId}`, '_blank');
}

// Validação do formulário
document.getElementById('updateEbookForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    
    // Mostrar loading
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner icon-sm me-1 animate-spin"></i> Atualizando...';
});

// Preview da nova imagem selecionada
document.getElementById('image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Criar ou atualizar preview
            let previewContainer = document.getElementById('newImagePreview');
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.id = 'newImagePreview';
                previewContainer.className = 'mt-3';
                document.getElementById('image').parentNode.appendChild(previewContainer);
            }
            
            previewContainer.innerHTML = `
                <label class="form-label fw-semibold text-success">Nova Capa Selecionada:</label>
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <img src="${e.target.result}" alt="Preview da nova capa" 
                             class="rounded shadow-sm border border-success" 
                             style="width: 80px; height: 80px; object-fit: cover;">
                    </div>
                    <div class="flex-grow-1">
                        <small class="text-success d-block">
                            <i class="fa-solid fa-check-circle icon-xs me-1"></i>
                            ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
                        </small>
                        <small class="text-muted d-block">
                            Clique em "Atualizar Ebook" para salvar a nova capa
                        </small>
                    </div>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        // Remover preview se nenhum arquivo selecionado
        const previewContainer = document.getElementById('newImagePreview');
        if (previewContainer) {
            previewContainer.remove();
        }
    }
});

// Inicializar Feather Icons
// (Removido para uso do FontAwesome)
</script>
{{end}}