{{ define "title" }}Configurações{{ end }}

{{ define "content" }}
<div class="container min-vh-100 d-flex align-items-center">
    <div class="row justify-content-center w-100">
        <div class="col-xl-8 col-lg-10 col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="mb-6">
                        <h4 class="mb-1">Assinatura</h4>
                    </div>
                    <div class="mb-3">
                        {{ if .user.IsInTrialPeriod }}
                            <div class="alert alert-info">
                                <p class="mb-0">Você está atualmente no período de teste. Restam {{ .user.DaysLeftInTrial }} dias.</p>
                            </div>
                        {{ else }}
                            <div class="alert alert-warning">
                                <p class="mb-0">Seu período de teste expirou. Por favor, assine para continuar usando a plataforma.</p>
                            </div>
                        {{ end }}
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" id="subscribe-button">
                            Assinar Agora
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const subscribeButton = document.getElementById('subscribe-button');
    if (subscribeButton) {
        subscribeButton.addEventListener('click', function() {
            const csrfToken = '{{ .user.CSRFToken }}';
            console.log('CSRF Token:', csrfToken); // Debug

            if (!csrfToken || csrfToken === '') {
                console.error('CSRF Token não encontrado');
                alert('Erro de segurança: Token CSRF não encontrado. Por favor, faça login novamente.');
                window.location.href = '/login';
                return;
            }

            // Redirecionar para o Checkout do Stripe
            fetch('/api/create-checkout-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                credentials: 'same-origin'
            })
            .then(async response => {
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('Resposta inválida:', await response.text());
                    throw new Error('Resposta inválida do servidor');
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erro na resposta:', errorData);
                    throw new Error(errorData.error || 'Erro na resposta do servidor');
                }
                
                return response.json();
            })
            .then(data => {
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    console.error('URL não recebida:', data);
                    throw new Error('URL de checkout não recebida');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                if (error.message === 'Resposta inválida do servidor') {
                    alert('Sua sessão expirou. Por favor, faça login novamente.');
                    window.location.href = '/login';
                } else {
                    alert('Ocorreu um erro ao processar sua assinatura. Por favor, tente novamente.');
                }
            });
        });
    }
});
</script>
{{ end }}
